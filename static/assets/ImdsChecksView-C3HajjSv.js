import{d as N,r as m,c as C,_ as T,j as q,k as A,a as g,e as n,f as h,x as d,q as V,u as t,I as S,n as L,t as _,A as w,J as B,K as O,o as p,L as k,M as F}from"./index-D2tkqljB.js";import{u as D}from"./executions-CLlZP_1s.js";const E="/api",U=N("imdsChecks",()=>{const y=m([]),s=m(null),b=m(null),r=m(!1),u=m(null),v=m(null),f=m({page:1,pageSize:50,total:0}),l=m({cloudProvider:null,region:null,imdsV1Enabled:null,ssrfVulnerable:null,riskLevel:null}),M=C(()=>y.value.filter(e=>e.imds_v1_enabled||e.ssrf_vulnerable||e.container_credential_exposure));async function x(){r.value=!0,u.value=null;try{const e=new URLSearchParams;e.append("page",f.value.page),e.append("page_size",f.value.pageSize),l.value.cloudProvider&&e.append("cloud_provider",l.value.cloudProvider),l.value.region&&e.append("region",l.value.region),l.value.imdsV1Enabled!==null&&e.append("imds_v1_enabled",l.value.imdsV1Enabled),l.value.ssrfVulnerable!==null&&e.append("ssrf_vulnerable",l.value.ssrfVulnerable),l.value.riskLevel&&e.append("risk_level",l.value.riskLevel);const o=await fetch(`${E}/imds-checks?${e}`);if(!o.ok)throw new Error("Failed to fetch IMDS checks");const c=await o.json();y.value=c.checks,f.value.total=c.total}catch(e){u.value=e.message,console.error("Error fetching IMDS checks:",e)}finally{r.value=!1}}async function R(){r.value=!0,u.value=null;try{const e=new URLSearchParams;e.append("page",f.value.page),e.append("page_size",f.value.pageSize);const o=await fetch(`${E}/imds-checks/vulnerable?${e}`);if(!o.ok)throw new Error("Failed to fetch vulnerable instances");const c=await o.json();y.value=c.checks,f.value.total=c.total}catch(e){u.value=e.message}finally{r.value=!1}}async function I(){try{const e=await fetch(`${E}/imds-checks/summary`);if(!e.ok)throw new Error("Failed to fetch summary");return b.value=await e.json(),b.value}catch(e){return console.error("Error fetching summary:",e),null}}async function $(e,o){try{if(!(await fetch(`${E}/imds-checks/${e}/remediation?status=${o}`,{method:"PATCH"})).ok)throw new Error("Failed to update remediation");return await x(),!0}catch(c){throw u.value=c.message,c}}async function P(e={}){r.value=!0,u.value=null;try{const o=await fetch(`${E}/imds-checks/scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error("Failed to run IMDS check");const c=await o.json();return v.value=c,c.status==="running"&&c.execution_id&&D().startPolling(c.execution_id,j=>{v.value=j,j.status==="completed"&&(x(),I())}),c}catch(o){throw u.value=o.message,o}finally{r.value=!1}}async function z(){var e;(e=v.value)!=null&&e.execution_id&&(await D().stopExecution(v.value.execution_id),v.value=null)}async function a(){var e;return(e=v.value)!=null&&e.execution_id?await D().fetchExecutionLogs(v.value.execution_id):null}function i(e){l.value={...l.value,...e},f.value.page=1,x()}return{checks:y,currentCheck:s,summary:b,loading:r,error:u,pagination:f,filters:l,currentExecution:v,vulnerableInstances:M,fetchChecks:x,fetchVulnerable:R,fetchSummary:I,updateRemediation:$,runScan:P,stopCurrentExecution:z,getExecutionLogs:a,setFilters:i}}),J={class:"imds-checks-view"},H={class:"page-header"},K={class:"header-actions"},Y={class:"execution-header"},G={class:"execution-info"},Q={class:"execution-title"},W={class:"execution-meta"},X={key:0,class:"execution-id"},Z={key:0,class:"execution-error"},ee={key:1,class:"execution-logs"},se={key:2,class:"execution-actions"},te={key:1,class:"summary-cards"},ne={class:"summary-card info"},ae={class:"card-value"},ie={class:"summary-card critical"},le={class:"card-value"},oe={class:"summary-card high"},ce={class:"card-value"},re={class:"summary-card medium"},ue={class:"card-value"},de={class:"filters-section"},ve={__name:"ImdsChecksView",setup(y){const s=U(),b=D(),r=m(!1),u=m(null),v=C(()=>{var a;return((a=s.currentExecution)==null?void 0:a.status)==="running"}),f=C(()=>{var i;const a=(i=s.currentExecution)==null?void 0:i.status;return{"status-running":a==="running","status-completed":a==="completed","status-failed":a==="failed","status-pending":a==="pending"}}),l=C(()=>{var e;const a=(e=s.currentExecution)==null?void 0:e.status;return{running:"pi pi-spin pi-spinner",completed:"pi pi-check-circle",failed:"pi pi-times-circle",pending:"pi pi-clock"}[a]||"pi pi-info-circle"}),M=C(()=>{var e;const a=(e=s.currentExecution)==null?void 0:e.status;return{running:"IMDS scan running...",completed:"IMDS scan completed",failed:"IMDS scan failed",pending:"IMDS scan pending"}[a]||"IMDS scan"});function x(a){return{critical:"danger",high:"warning",medium:"info",low:"success"}[a]||"secondary"}function R(){r.value=!r.value,r.value?s.fetchVulnerable():s.fetchChecks()}async function I(){u.value=null,await s.runScan({})}async function $(){await s.stopCurrentExecution()}function P(){s.currentExecution=null,u.value=null}function z(a){s.pagination.page=a.page+1,r.value?s.fetchVulnerable():s.fetchChecks()}return q(()=>{s.fetchChecks(),s.fetchSummary()}),A(()=>{var a;(a=s.currentExecution)!=null&&a.execution_id&&b.stopPolling(s.currentExecution.execution_id)}),(a,i)=>(p(),g("div",J,[n("div",H,[i[1]||(i[1]=n("div",{class:"header-content"},[n("h1",null,"IMDS/Metadata Checks"),n("p",{class:"subtitle"},"Instance metadata service vulnerability checks")],-1)),n("div",K,[v.value?(p(),V(t(S),{key:1,label:"Stop",icon:"pi pi-stop",severity:"danger",onClick:$})):(p(),V(t(S),{key:0,label:"Run Scan",icon:"pi pi-play",onClick:I,loading:t(s).loading},null,8,["loading"]))])]),t(s).currentExecution?(p(),g("div",{key:0,class:L(["execution-panel",f.value])},[n("div",Y,[n("div",G,[n("i",{class:L([l.value,"execution-icon"])},null,2),n("span",Q,_(M.value),1)]),n("div",W,[t(s).currentExecution.execution_id?(p(),g("span",X," ID: "+_(t(s).currentExecution.execution_id),1)):h("",!0)])]),t(s).currentExecution.error?(p(),g("div",Z,_(t(s).currentExecution.error),1)):h("",!0),u.value?(p(),g("div",ee,[n("pre",null,_(u.value),1)])):h("",!0),v.value?h("",!0):(p(),g("div",se,[d(t(S),{label:"Dismiss",text:"",size:"small",onClick:P}),t(s).currentExecution.status==="completed"?(p(),V(t(S),{key:0,label:"View Results",size:"small",onClick:i[0]||(i[0]=e=>t(s).fetchChecks())})):h("",!0)]))],2)):h("",!0),t(s).summary?(p(),g("div",te,[n("div",ne,[n("div",ae,_(t(s).summary.total_instances),1),i[2]||(i[2]=n("div",{class:"card-label"},"Total Instances",-1))]),n("div",ie,[n("div",le,_(t(s).summary.imds_v1_enabled),1),i[3]||(i[3]=n("div",{class:"card-label"},"IMDSv1 Enabled",-1))]),n("div",oe,[n("div",ce,_(t(s).summary.ssrf_vulnerable),1),i[4]||(i[4]=n("div",{class:"card-label"},"SSRF Vulnerable",-1))]),n("div",re,[n("div",ue,_(t(s).summary.container_exposed),1),i[5]||(i[5]=n("div",{class:"card-label"},"Container Exposed",-1))])])):h("",!0),n("div",de,[d(t(S),{label:r.value?"Show All":"Show Vulnerable",icon:r.value?"pi pi-list":"pi pi-exclamation-triangle",onClick:R},null,8,["label","icon"])]),d(t(B),{value:t(s).checks,loading:t(s).loading,responsiveLayout:"scroll",class:"p-datatable-sm"},{default:w(()=>[d(t(k),{field:"instance_id",header:"Instance ID"}),d(t(k),{field:"instance_name",header:"Name"}),d(t(k),{field:"region",header:"Region"}),d(t(k),{field:"imds_v1_enabled",header:"IMDSv1"},{body:w(({data:e})=>[d(t(F),{severity:e.imds_v1_enabled?"danger":"success",value:e.imds_v1_enabled?"Enabled":"Disabled"},null,8,["severity","value"])]),_:1}),d(t(k),{field:"http_tokens_required",header:"Tokens Required"},{body:w(({data:e})=>[d(t(F),{severity:e.http_tokens_required?"success":"warning",value:e.http_tokens_required?"Yes":"No"},null,8,["severity","value"])]),_:1}),d(t(k),{field:"ssrf_vulnerable",header:"SSRF"},{body:w(({data:e})=>[n("i",{class:L(e.ssrf_vulnerable?"pi pi-exclamation-triangle text-danger":"pi pi-check text-success")},null,2)]),_:1}),d(t(k),{field:"risk_level",header:"Risk"},{body:w(({data:e})=>[d(t(F),{severity:x(e.risk_level),value:e.risk_level},null,8,["severity","value"])]),_:1})]),_:1},8,["value","loading"]),t(s).pagination.total>t(s).pagination.pageSize?(p(),V(t(O),{key:2,rows:t(s).pagination.pageSize,totalRecords:t(s).pagination.total,first:(t(s).pagination.page-1)*t(s).pagination.pageSize,onPage:z},null,8,["rows","totalRecords","first"])):h("",!0)]))}},he=T(ve,[["__scopeId","data-v-850f3036"]]);export{he as default};
