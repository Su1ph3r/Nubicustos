name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # Python Linting with Ruff
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff==0.4.4

      - name: Run ruff linter
        run: ruff check api/ report-processor/ scripts/

      - name: Run ruff formatter check
        run: ruff format --check api/ report-processor/ scripts/

  # Frontend Linting with ESLint
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present

  # Python Tests with Pytest
  test-python:
    name: Test Python
    runs-on: ubuntu-latest
    needs: lint-python
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_security_audits
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install API dependencies
        run: |
          pip install -r api/requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Install report-processor dependencies
        run: pip install -r report-processor/requirements.txt

      - name: Run API tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_security_audits
          DB_USER: test_user
          DB_PASSWORD: test_password
        run: |
          pytest api/ -v --cov=api --cov-report=xml --cov-report=term-missing || echo "No tests found in api/"

      - name: Run report-processor tests
        run: |
          pytest report-processor/ -v --cov=report-processor --cov-report=xml --cov-report=term-missing || echo "No tests found in report-processor/"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # Frontend Tests with Vitest
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: lint-frontend
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test --if-present || echo "No test script configured"

  # Build Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [lint-frontend, test-frontend]
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  # Build Docker Images
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-python, build-frontend]
    strategy:
      matrix:
        image:
          - name: api
            context: ./api
            dockerfile: ./api/Dockerfile
          - name: report-processor
            context: ./report-processor
            dockerfile: ./report-processor/Dockerfile
          - name: cloudmapper
            context: ./cloudmapper
            dockerfile: ./cloudmapper/Dockerfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.image.name }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          push: false
          tags: nubicustos/${{ matrix.image.name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Generate SBOM
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate Python SBOM (API)
        run: |
          syft dir:api -o cyclonedx-json=sbom-api.json

      - name: Generate Python SBOM (Report Processor)
        run: |
          syft dir:report-processor -o cyclonedx-json=sbom-report-processor.json

      - name: Generate Frontend SBOM
        run: |
          cd frontend && npm ci
          syft dir:. -o cyclonedx-json=../sbom-frontend.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom-*.json
          retention-days: 30

  # Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [test-python, build-frontend]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
