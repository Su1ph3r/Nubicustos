version: '3.8'

services:
  # ============================================================================
  # AWS Security Tools
  # ============================================================================
  
  prowler:
    image: prowler-cloud/prowler:latest
    container_name: prowler
    volumes:
      - ./reports/prowler:/reports
      - ./credentials/aws:/root/.aws:ro
      - ./logs:/logs
    environment:
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
      - AWS_CONFIG_FILE=/root/.aws/config
    command: |
      aws
      --output-modes json,html,csv
      --output-directory /reports
      --log-file /logs/prowler.log
    networks:
      - security-net
    restart: unless-stopped
  
  scoutsuite-aws:
    image: rossja/scoutsuite:latest
    container_name: scoutsuite-aws
    volumes:
      - ./reports/scoutsuite:/reports
      - ./credentials/aws:/root/.aws:ro
    command: |
      aws
      --report-dir /reports/aws
      --no-browser
    networks:
      - security-net
    restart: unless-stopped
  
  pacu:
    image: rhinosecuritylabs/pacu:latest
    container_name: pacu
    volumes:
      - ./reports/pacu:/reports
      - ./credentials/aws:/root/.aws:ro
      - pacu-data:/root/.local/share/pacu
    environment:
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
    networks:
      - security-net
    stdin_open: true
    tty: true
    restart: unless-stopped
  
  # ============================================================================
  # Multi-Cloud Security Tools
  # ============================================================================
  
  cloudsploit:
    image: aquasec/cloudsploit:latest
    container_name: cloudsploit
    volumes:
      - ./reports/cloudsploit:/reports
      - ./credentials:/root/.config:ro
      - ./config/cloudsploit:/config:ro
    environment:
      - AWS_SHARED_CREDENTIALS_FILE=/root/.config/aws/credentials
      - AZURE_CONFIG_DIR=/root/.config/azure
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcp/credentials.json
    command: --config /config/config.js --console none --json /reports/output.json
    networks:
      - security-net
    restart: unless-stopped
  
  cloud-custodian:
    image: cloudcustodian/c7n:latest
    container_name: cloud-custodian
    volumes:
      - ./policies:/policies:ro
      - ./reports/custodian:/output
      - ./credentials/aws:/root/.aws:ro
      - ./logs:/logs
    environment:
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
    command: run -s /output --log-group=/logs/custodian.log /policies/*.yml
    networks:
      - security-net
    restart: unless-stopped
  
  cloudmapper:
    build: ./cloudmapper
    container_name: cloudmapper
    volumes:
      - ./reports/cloudmapper:/reports
      - ./credentials/aws:/root/.aws:ro
      - ./config/cloudmapper:/config:ro
    environment:
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
    networks:
      - security-net
    restart: unless-stopped
  
  # ============================================================================
  # Kubernetes Security Tools
  # ============================================================================
  
  kube-bench:
    image: aquasec/kube-bench:latest
    container_name: kube-bench
    volumes:
      - ./kubeconfigs:/root/.kube:ro
      - ./reports/kube-bench:/reports
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: --config-dir /opt/kube-bench/cfg --outputfile /reports/kube-bench-report.json --json
    networks:
      - security-net
    restart: unless-stopped
  
  kubescape:
    image: quay.io/armosec/kubescape:latest
    container_name: kubescape
    volumes:
      - ./kubeconfigs:/root/.kube:ro
      - ./reports/kubescape:/reports
    command: |
      scan
      --format json
      --output /reports/kubescape-results.json
      --submit=false
      --verbose
    networks:
      - security-net
    restart: unless-stopped
  
  kube-hunter:
    image: aquasec/kube-hunter:latest
    container_name: kube-hunter
    volumes:
      - ./kubeconfigs:/root/.kube:ro
      - ./reports/kube-hunter:/reports
    command: --report json --log /reports/kube-hunter.json
    networks:
      - security-net
    restart: unless-stopped
  
  trivy:
    image: aquasec/trivy:latest
    container_name: trivy
    volumes:
      - ./reports/trivy:/reports
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - trivy-cache:/root/.cache
    environment:
      - TRIVY_CACHE_DIR=/root/.cache
    command: --cache-dir /root/.cache
    networks:
      - security-net
    restart: unless-stopped
  
  grype:
    image: anchore/grype:latest
    container_name: grype
    volumes:
      - ./reports/grype:/reports
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - grype-cache:/root/.cache
    environment:
      - GRYPE_DB_CACHE_DIR=/root/.cache
    networks:
      - security-net
    restart: unless-stopped
  
  popeye:
    image: derailed/popeye:latest
    container_name: popeye
    volumes:
      - ./kubeconfigs:/root/.kube:ro
      - ./reports/popeye:/reports
    command: --output json --save --output-file /reports/popeye-report.json
    networks:
      - security-net
    restart: unless-stopped
  
  falco:
    image: falcosecurity/falco-no-driver:latest
    container_name: falco
    privileged: true
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock:ro
      - ./config/falco:/etc/falco:ro
      - ./logs/falco:/var/log/falco
    environment:
      - HOST_ROOT=/host
    command: -o json_output=true -o json_output_file=/var/log/falco/events.json
    networks:
      - security-net
    restart: unless-stopped
  
  # ============================================================================
  # Infrastructure-as-Code Security
  # ============================================================================
  
  checkov:
    image: bridgecrew/checkov:latest
    container_name: checkov
    volumes:
      - ./iac-code:/code:ro
      - ./reports/checkov:/reports
    command: |
      -d /code
      --output json
      --output-file-path /reports
      --framework terraform cloudformation kubernetes helm arm
      --quiet
    networks:
      - security-net
    restart: unless-stopped
  
  terrascan:
    image: tenable/terrascan:latest
    container_name: terrascan
    volumes:
      - ./iac-code:/iac:ro
      - ./reports/terrascan:/reports
    command: |
      scan
      -d /iac
      -o json
      -f /reports/terrascan-results.json
    networks:
      - security-net
    restart: unless-stopped
  
  tfsec:
    image: aquasec/tfsec:latest
    container_name: tfsec
    volumes:
      - ./iac-code:/src:ro
      - ./reports/tfsec:/reports
    command: |
      /src
      --format json
      --out /reports/tfsec-results.json
      --soft-fail
    networks:
      - security-net
    restart: unless-stopped
  
  # ============================================================================
  # Asset Mapping & Visualization
  # ============================================================================
  
  cartography:
    image: lyft/cartography:latest
    container_name: cartography
    depends_on:
      - neo4j
    volumes:
      - ./credentials/aws:/root/.aws:ro
      - ./credentials/gcp:/root/.config/gcp:ro
      - ./logs:/logs
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-cloudsecurity}
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcp/credentials.json
    command: --neo4j-uri bolt://neo4j:7687 --neo4j-user neo4j --neo4j-password ${NEO4J_PASSWORD:-cloudsecurity}
    networks:
      - security-net
    restart: unless-stopped
  
  neo4j:
    image: neo4j:5.14-community
    container_name: neo4j
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-cloudsecurity}
      - NEO4J_dbms_memory_heap_max__size=4G
      - NEO4J_dbms_memory_pagecache_size=2G
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins
    networks:
      - security-net
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
  
  # ============================================================================
  # Storage & Database
  # ============================================================================
  
  postgresql:
    image: postgres:15-alpine
    container_name: postgresql
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-security_audits}
      - POSTGRES_USER=${POSTGRES_USER:-auditor}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./logs/postgresql:/var/log/postgresql
    networks:
      - security-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-auditor}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  
  # ============================================================================
  # Web Interface & Reports
  # ============================================================================
  
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "${NGINX_PORT:-8080}:80"
    volumes:
      - ./reports:/usr/share/nginx/html/reports:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/usr/share/nginx/html:ro
      - ./logs/nginx:/var/log/nginx
    networks:
      - security-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # REST API
  # ============================================================================

  api:
    build: ./api
    container_name: security-api
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - DB_HOST=postgresql
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-security_audits}
      - DB_USER=${POSTGRES_USER:-auditor}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - API_KEY=${API_KEY:-}
      - API_CORS_ORIGINS=${API_CORS_ORIGINS:-http://localhost:8080,http://localhost:3000}
    volumes:
      - ./reports:/reports:ro
      - ./scripts:/app/scripts:ro
    depends_on:
      postgresql:
        condition: service_healthy
    networks:
      - security-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # Monitoring & Dashboards
  # ============================================================================

  grafana:
    image: grafana/grafana:10.2-alpine
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel
      - GF_SERVER_ROOT_URL=http://localhost:${GRAFANA_PORT:-3000}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      postgresql:
        condition: service_healthy
    networks:
      - security-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================

networks:
  security-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================================================
# Volumes
# ============================================================================

volumes:
  postgres-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-plugins:
    driver: local
  pacu-data:
    driver: local
  trivy-cache:
    driver: local
  grype-cache:
    driver: local
  grafana-data:
    driver: local
